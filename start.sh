#!/bin/bash

set -e

source ./helper.sh

# Parse command line arguments
PRESERVE_CONTAINERS=false
USE_PLAIN=false
NO_CACHE=false
FEATURE="common"
TEST_MODE="scenarios"                                    # é»˜è®¤æ¨¡å¼: scenarios, autogenerated, global
BASE_IMAGE="mcr.microsoft.com/devcontainers/base:ubuntu" # ç”¨äº autogenerated æ¨¡å¼

usage() {
  echo "Usage: $0 [OPTIONS]"
  echo ""
  echo "Options:"
  echo "  -p, --preserve        ä¸åˆ é™¤æµ‹è¯•å®¹å™¨å’Œé•œåƒ(æ‰§è¡Œåæ‰“å°å®¹å™¨ä¿¡æ¯)"
  echo "  --plain               ä½¿ç”¨ plain æ¨¡å¼æ˜¾ç¤ºæ„å»ºè¿›åº¦"
  echo "  --no-cache            åˆ é™¤æ‰€æœ‰ vsc- å¼€å¤´çš„æµ‹è¯•å®¹å™¨"
  echo "  -f, --feature NAME    æŒ‡å®šè¦æµ‹è¯•çš„ feature (é»˜è®¤: common)"
  echo "  -m, --mode MODE       æµ‹è¯•æ¨¡å¼: scenarios, autogenerated, global (é»˜è®¤: scenarios)"
  echo "  -i, --image IMAGE     åŸºç¡€é•œåƒ (ä»…ç”¨äº autogenerated æ¨¡å¼)"
  echo "  -h, --help            æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
  echo ""
  echo "æµ‹è¯•æ¨¡å¼è¯´æ˜:"
  echo "  scenarios      - è¿è¡Œ scenarios æµ‹è¯• (é»˜è®¤)"
  echo "  autogenerated  - è¿è¡Œè‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•ï¼Œå¯æŒ‡å®šåŸºç¡€é•œåƒ"
  echo "  global         - è¿è¡Œå…¨å±€åœºæ™¯æµ‹è¯•"
  echo ""
  echo "ç¤ºä¾‹:"
  echo "  $0                              # è¿è¡Œ scenarios æµ‹è¯•"
  echo "  $0 -m autogenerated             # è¿è¡Œè‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•"
  echo "  $0 -m autogenerated -i debian:latest  # é’ˆå¯¹ debian:latest è¿è¡Œæµ‹è¯•"
  echo "  $0 -m global                    # è¿è¡Œå…¨å±€åœºæ™¯æµ‹è¯•"
  echo "  $0 --preserve                   # æ‰§è¡Œåä¿ç•™å®¹å™¨å’Œé•œåƒ"
  echo "  $0 --plain                      # ä½¿ç”¨ plain æ¨¡å¼æ˜¾ç¤ºè¯¦ç»†è¾“å‡º"
  echo "  $0 --no-cache                   # æ¸…ç†æ‰€æœ‰ vsc- æµ‹è¯•å®¹å™¨"
  echo "  $0 -f common -m scenarios       # æµ‹è¯• common feature çš„ scenarios"
  echo "  $0 --preserve --plain           # ä¿ç•™å®¹å™¨å¹¶ä½¿ç”¨ plain æ¨¡å¼"

  exit 0
}

while [[ $# -gt 0 ]]; do
  case $1 in
  -p | --preserve)
    PRESERVE_CONTAINERS=true
    shift
    ;;
  --plain)
    USE_PLAIN=true
    shift
    ;;
  --no-cache)
    NO_CACHE=true
    shift
    ;;
  -f | --feature)
    FEATURE="$2"
    shift 2
    ;;
  -m | --mode)
    TEST_MODE="$2"
    if [[ "$TEST_MODE" != "scenarios" && "$TEST_MODE" != "autogenerated" && "$TEST_MODE" != "global" ]]; then
      echo "é”™è¯¯: æ— æ•ˆçš„æµ‹è¯•æ¨¡å¼ '$TEST_MODE'"
      echo "æœ‰æ•ˆçš„æ¨¡å¼: scenarios, autogenerated, global"
      echo ""
      usage
      exit 1
    fi
    shift 2
    ;;
  -i | --image)
    BASE_IMAGE="$2"
    shift 2
    ;;
  *)
    echo "æœªçŸ¥é€‰é¡¹: $1"
    echo ""
    usage
    exit 1
    ;;
  esac
done

[ "$help" = "true" ] && usage

# Handle no-cache mode
if [ "$NO_CACHE" = true ]; then
  echo "æ¸…ç† vsc-*-features-uid æµ‹è¯•å®¹å™¨å’Œæ„å»ºç¼“å­˜..."
  echo ""

  # 1. åˆ é™¤å®¹å™¨
  VSC_CONTAINERS=$(docker ps -a --format "{{.ID}}\t{{.Image}}" | grep "vsc-.*-features-uid" | awk '{print $1}')
  if [ -n "$VSC_CONTAINERS" ]; then
    echo "æ‰¾åˆ°ä»¥ä¸‹å®¹å™¨:"
    docker ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Image}}\t{{.Status}}\t{{.CreatedAt}}" | grep -E "CONTAINER ID|vsc-.*-features-uid"
    echo ""
    echo "æ­£åœ¨åˆ é™¤å®¹å™¨..."
    echo "$VSC_CONTAINERS" | xargs docker rm -f
    echo "$(green 'âœ“ å®¹å™¨æ¸…ç†å®Œæˆ')"
  else
    echo "$(yellow 'æ²¡æœ‰æ‰¾åˆ° vsc-*-features-uid æµ‹è¯•å®¹å™¨')"
  fi
  echo ""

  # 2. åˆ é™¤é•œåƒ
  VSC_IMAGES=$(docker images --format "{{.ID}}\t{{.Repository}}" | grep "vsc-.*-features-uid" | awk '{print $1}')
  if [ -n "$VSC_IMAGES" ]; then
    echo "æ‰¾åˆ°ä»¥ä¸‹é•œåƒ:"
    docker images --format "table {{.ID}}\t{{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" | grep -E "IMAGE ID|vsc-.*-features-uid"
    echo ""
    echo "æ­£åœ¨åˆ é™¤é•œåƒ..."
    echo "$VSC_IMAGES" | xargs docker rmi -f
    echo "$(green 'âœ“ é•œåƒæ¸…ç†å®Œæˆ')"
  else
    echo "$(yellow 'æ²¡æœ‰æ‰¾åˆ° vsc-*-features-uid æµ‹è¯•é•œåƒ')"
  fi
  echo ""

  # 3. æ¸…ç†æ„å»ºç¼“å­˜
  echo "æ­£åœ¨æ¸…ç† Docker æ„å»ºç¼“å­˜..."
  docker builder prune -af
  echo "$(green 'âœ“ æ„å»ºç¼“å­˜æ¸…ç†å®Œæˆ')"
  echo ""

  echo "$(green 'ğŸ‰ æ‰€æœ‰æ¸…ç†æ“ä½œå®Œæˆï¼')"
  exit 0
fi

# Set BUILDKIT_PROGRESS if plain mode is enabled
if [ "$USE_PLAIN" = true ]; then
  export BUILDKIT_PROGRESS=plain
  echo "ä½¿ç”¨ plain æ¨¡å¼æ˜¾ç¤ºæ„å»ºè¿›åº¦"
fi

# Build the command based on test mode
case $TEST_MODE in
scenarios)
  echo "$(green 'è¿è¡Œ scenarios æµ‹è¯•æ¨¡å¼')"
  CMD="devcontainer features test -f $FEATURE --skip-autogenerated --skip-duplicated"
  ;;
autogenerated)
  echo "$(green 'è¿è¡Œ autogenerated æµ‹è¯•æ¨¡å¼')"
  CMD="devcontainer features test --skip-scenarios -f $FEATURE"
  if [ -n "$BASE_IMAGE" ]; then
    CMD="$CMD -i $BASE_IMAGE"
    echo "åŸºç¡€é•œåƒ: $BASE_IMAGE"
  else
    echo "$(yellow 'æç¤º: å¯ä»¥ä½¿ç”¨ -i é€‰é¡¹æŒ‡å®šåŸºç¡€é•œåƒ')"
  fi
  ;;
global)
  echo "$(green 'è¿è¡Œ global æµ‹è¯•æ¨¡å¼')"
  CMD="devcontainer features test --global-scenarios-only"
  if [ "$FEATURE" != "common" ]; then
    echo "$(yellow 'æ³¨æ„: global æ¨¡å¼ä¼šå¿½ç•¥ -f/--feature é€‰é¡¹')"
  fi
  ;;
esac

# Add preserve flag if enabled
if [ "$PRESERVE_CONTAINERS" = true ]; then
  CMD="$CMD --preserve-test-containers"
  echo "å°†ä¿ç•™æµ‹è¯•å®¹å™¨å’Œé•œåƒ"
fi

CMD="$CMD $(pwd)"

echo "æ‰§è¡Œå‘½ä»¤: $CMD"
echo ""

# Execute the command
eval $CMD

# Show container info if preserve mode is enabled
if [ "$PRESERVE_CONTAINERS" = true ]; then
  echo ""
  echo "=================================================="
  echo "ä¿ç•™çš„æµ‹è¯•å®¹å™¨ä¿¡æ¯:"
  echo "=================================================="
  VSC_CONTAINERS=$(docker ps -a --format "{{.ID}}\t{{.Image}}" | grep "vsc-.*-features-uid" | awk '{print $1}')
  if [ -n "$VSC_CONTAINERS" ]; then
    docker ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Image}}\t{{.Status}}\t{{.CreatedAt}}" | grep -E "CONTAINER ID|vsc-.*-features-uid"
    echo ""
    echo "$(green 'æç¤º: ä½¿ç”¨ --no-cache é€‰é¡¹å¯ä»¥æ¸…ç†è¿™äº›å®¹å™¨')"
  else
    echo "$(yellow 'æ²¡æœ‰æ‰¾åˆ° vsc-*-features-uid æµ‹è¯•å®¹å™¨')"
  fi
  echo "=================================================="
fi
