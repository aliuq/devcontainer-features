#!/bin/bash

set -e

source ./helper.sh

# Parse command line arguments
PRESERVE_CONTAINERS=false
USE_PLAIN=false
NO_CACHE=false
FEATURE="common"

usage() {
  echo "Usage: $0 [OPTIONS]"
  echo ""
  echo "Options:"
  echo "  -p, --preserve        ä¸åˆ é™¤æµ‹è¯•å®¹å™¨å’Œé•œåƒ(æ‰§è¡Œåæ‰“å°å®¹å™¨ä¿¡æ¯)"
  echo "  --plain               ä½¿ç”¨ plain æ¨¡å¼æ˜¾ç¤ºæ„å»ºè¿›åº¦"
  echo "  --no-cache            åˆ é™¤æ‰€æœ‰ vsc- å¼€å¤´çš„æµ‹è¯•å®¹å™¨"
  echo "  -f, --feature NAME    æŒ‡å®šè¦æµ‹è¯•çš„ feature (é»˜è®¤: common)"
  echo "  -h, --help            æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
  echo ""
  echo "ç¤ºä¾‹:"
  echo "  $0                    # æ­£å¸¸æ‰§è¡Œï¼Œæµ‹è¯• common feature"
  echo "  $0 --preserve         # æ‰§è¡Œåä¿ç•™å®¹å™¨å’Œé•œåƒï¼Œå¹¶æ‰“å°å®¹å™¨ä¿¡æ¯"
  echo "  $0 --plain            # ä½¿ç”¨ plain æ¨¡å¼æ˜¾ç¤ºè¯¦ç»†è¾“å‡º"
  echo "  $0 --no-cache         # æ¸…ç†æ‰€æœ‰ vsc- æµ‹è¯•å®¹å™¨"
  echo "  $0 -f hello           # æµ‹è¯• hello feature"
  echo "  $0 --preserve --plain # ä¿ç•™å®¹å™¨å¹¶ä½¿ç”¨ plain æ¨¡å¼"

  exit 0
}

while [[ $# -gt 0 ]]; do
  case $1 in
    -p|--preserve)
      PRESERVE_CONTAINERS=true
      shift
      ;;
    --plain)
      USE_PLAIN=true
      shift
      ;;
    --no-cache)
      NO_CACHE=true
      shift
      ;;
    -f|--feature)
      FEATURE="$2"
      shift 2
      ;;
    *)
      echo "æœªçŸ¥é€‰é¡¹: $1"
      echo ""
      usage
      exit 1
      ;;
  esac
done

[ "$help" = "true" ] && usage

# Handle no-cache mode
if [ "$NO_CACHE" = true ]; then
  echo "æ¸…ç† vsc-*-features-uid æµ‹è¯•å®¹å™¨å’Œæ„å»ºç¼“å­˜..."
  echo ""
  
  # 1. åˆ é™¤å®¹å™¨
  VSC_CONTAINERS=$(docker ps -a --format "{{.ID}}\t{{.Image}}" | grep "vsc-.*-features-uid" | awk '{print $1}')
  if [ -n "$VSC_CONTAINERS" ]; then
    echo "æ‰¾åˆ°ä»¥ä¸‹å®¹å™¨:"
    docker ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Image}}\t{{.Status}}\t{{.CreatedAt}}" | grep -E "CONTAINER ID|vsc-.*-features-uid"
    echo ""
    echo "æ­£åœ¨åˆ é™¤å®¹å™¨..."
    echo "$VSC_CONTAINERS" | xargs docker rm -f
    echo "$(green 'âœ“ å®¹å™¨æ¸…ç†å®Œæˆ')"
  else
    echo "$(yellow 'æ²¡æœ‰æ‰¾åˆ° vsc-*-features-uid æµ‹è¯•å®¹å™¨')"
  fi
  echo ""
  
  # 2. åˆ é™¤é•œåƒ
  VSC_IMAGES=$(docker images --format "{{.ID}}\t{{.Repository}}" | grep "vsc-.*-features-uid" | awk '{print $1}')
  if [ -n "$VSC_IMAGES" ]; then
    echo "æ‰¾åˆ°ä»¥ä¸‹é•œåƒ:"
    docker images --format "table {{.ID}}\t{{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" | grep -E "IMAGE ID|vsc-.*-features-uid"
    echo ""
    echo "æ­£åœ¨åˆ é™¤é•œåƒ..."
    echo "$VSC_IMAGES" | xargs docker rmi -f
    echo "$(green 'âœ“ é•œåƒæ¸…ç†å®Œæˆ')"
  else
    echo "$(yellow 'æ²¡æœ‰æ‰¾åˆ° vsc-*-features-uid æµ‹è¯•é•œåƒ')"
  fi
  echo ""
  
  # 3. æ¸…ç†æ„å»ºç¼“å­˜
  echo "æ­£åœ¨æ¸…ç† Docker æ„å»ºç¼“å­˜..."
  docker builder prune -af
  echo "$(green 'âœ“ æ„å»ºç¼“å­˜æ¸…ç†å®Œæˆ')"
  echo ""
  
  echo "$(green 'ğŸ‰ æ‰€æœ‰æ¸…ç†æ“ä½œå®Œæˆï¼')"
  exit 0
fi

# Set BUILDKIT_PROGRESS if plain mode is enabled
if [ "$USE_PLAIN" = true ]; then
  export BUILDKIT_PROGRESS=plain
  echo "ä½¿ç”¨ plain æ¨¡å¼æ˜¾ç¤ºæ„å»ºè¿›åº¦"
fi

# Build the command
CMD="devcontainer features test -f $FEATURE --skip-autogenerated --skip-duplicated"

# Add preserve flag if enabled
if [ "$PRESERVE_CONTAINERS" = true ]; then
  CMD="$CMD --preserve-test-containers"
  echo "å°†ä¿ç•™æµ‹è¯•å®¹å™¨å’Œé•œåƒ"
fi

CMD="$CMD $(pwd)"

echo "æ‰§è¡Œå‘½ä»¤: $CMD"
echo ""

# Execute the command
eval $CMD

# Show container info if preserve mode is enabled
if [ "$PRESERVE_CONTAINERS" = true ]; then
  echo ""
  echo "=================================================="
  echo "ä¿ç•™çš„æµ‹è¯•å®¹å™¨ä¿¡æ¯:"
  echo "=================================================="
  VSC_CONTAINERS=$(docker ps -a --format "{{.ID}}\t{{.Image}}" | grep "vsc-.*-features-uid" | awk '{print $1}')
  if [ -n "$VSC_CONTAINERS" ]; then
    docker ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Image}}\t{{.Status}}\t{{.CreatedAt}}" | grep -E "CONTAINER ID|vsc-.*-features-uid"
    echo ""
    echo "$(green 'æç¤º: ä½¿ç”¨ --no-cache é€‰é¡¹å¯ä»¥æ¸…ç†è¿™äº›å®¹å™¨')"
  else
    echo "$(yellow 'æ²¡æœ‰æ‰¾åˆ° vsc-*-features-uid æµ‹è¯•å®¹å™¨')"
  fi
  echo "=================================================="
fi
